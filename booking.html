<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salon Assist CX ‚Äî Book an Appointment</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Lato:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://pwytzdclfiuepbcceoqd.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3eXR6ZGNsZml1ZXBiY2Nlb3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTUzMzAsImV4cCI6MjA4NzI5MTMzMH0.lemmT3-2ooVyQN9X-wVnssqJ1epZ4DCoLEMy23gfYSE';
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --cream: #faf6f1; --warm-white: #fff9f4;
  --terracotta: #c4714a; --terracotta-light: #d98b6a;
  --sage: #7a9178; --bark: #5c4033;
  --sand: #e8d9c8; --sand-dark: #d4c0ab;
  --text-dark: #2d1f18; --text-mid: #6b4c3b; --text-light: #9c7a6a;
  --border: #ddd0be;
}
body { font-family: 'Lato', sans-serif; background-color: var(--cream); color: var(--text-dark); min-height: 100vh; }

#loadingScreen {
  position: fixed; inset: 0; background: var(--cream);
  display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; gap: 14px;
}
.spinner { width: 32px; height: 32px; border-radius: 50%; border: 3px solid var(--sand); border-top-color: var(--terracotta); animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
#loadingScreen p { font-size: 0.82rem; color: var(--text-light); font-weight: 300; }

.hero { background: linear-gradient(160deg, #3d2416 0%, #5c3525 40%, #7a4a35 100%); position: relative; overflow: hidden; }
.hero::before { content: ''; position: absolute; inset: 0; background: radial-gradient(ellipse at 20% 50%, rgba(196,113,74,0.25) 0%, transparent 60%); }
.hero-inner { position: relative; display: flex; align-items: center; gap: 40px; padding: 48px 60px; max-width: 1100px; margin: 0 auto; }
.stylist-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid rgba(232,217,200,0.4); background: linear-gradient(135deg, var(--terracotta) 0%, var(--bark) 100%); display: flex; align-items: center; justify-content: center; font-family: 'Playfair Display', serif; font-size: 42px; color: var(--cream); flex-shrink: 0; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
.hero-text h1 { font-family: 'Playfair Display', serif; font-size: 2.6rem; color: var(--cream); font-weight: 400; line-height: 1.2; }
.hero-text h1 em { color: var(--terracotta-light); font-style: italic; }
.hero-text p { margin-top: 10px; font-size: 0.95rem; color: rgba(232,217,200,0.75); font-weight: 300; }
.hero-badges { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
.badge { background: rgba(232,217,200,0.12); border: 1px solid rgba(232,217,200,0.25); color: var(--sand); font-size: 0.75rem; padding: 5px 14px; border-radius: 20px; letter-spacing: 0.8px; text-transform: uppercase; font-weight: 500; }

.main { max-width: 1100px; margin: 0 auto; padding: 40px 60px 60px; display: grid; grid-template-columns: 1fr 1.6fr; gap: 36px; align-items: start; }

.availability-panel { background: var(--warm-white); border-radius: 20px; border: 1px solid var(--sand); overflow: hidden; box-shadow: 0 4px 24px rgba(92,64,51,0.07); }
.panel-header { background: linear-gradient(135deg, var(--sand) 0%, #e0ccb8 100%); padding: 22px 28px; border-bottom: 1px solid var(--sand-dark); }
.panel-header h2 { font-family: 'Playfair Display', serif; font-size: 1.15rem; color: var(--bark); font-weight: 600; }
.panel-header p { font-size: 0.8rem; color: var(--text-light); margin-top: 3px; font-weight: 300; }
.availability-body { padding: 24px 28px; }
.week-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-light); font-weight: 600; margin-bottom: 14px; }
.day-row { display: flex; align-items: flex-start; gap: 12px; padding: 10px 0; border-bottom: 1px solid rgba(232,217,200,0.6); }
.day-row:last-child { border-bottom: none; }
.day-name { font-size: 0.82rem; font-weight: 500; color: var(--text-mid); min-width: 80px; flex-shrink: 0; padding-top: 3px; }
.slots { display: flex; flex-wrap: wrap; gap: 6px; }
.slot { font-size: 0.72rem; padding: 4px 10px; border-radius: 6px; font-weight: 500; }
.slot.open { background: rgba(122,145,120,0.12); color: var(--sage); border: 1px solid rgba(122,145,120,0.3); }
.slot.booked { background: rgba(92,64,51,0.06); color: var(--text-light); border: 1px solid rgba(92,64,51,0.1); text-decoration: line-through; opacity: 0.6; }
.closed-label { font-size: 0.72rem; color: var(--sand-dark); font-style: italic; padding-top: 3px; }
.legend { display: flex; gap: 16px; margin-top: 18px; padding-top: 16px; border-top: 1px solid var(--sand); }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.72rem; color: var(--text-light); }
.legend-dot { width: 8px; height: 8px; border-radius: 50%; }
.legend-dot.open { background: var(--sage); }
.legend-dot.booked { background: var(--sand-dark); }

.chat-panel { background: var(--warm-white); border-radius: 20px; border: 1px solid var(--sand); box-shadow: 0 4px 24px rgba(92,64,51,0.07); display: flex; flex-direction: column; height: 560px; overflow: hidden; }
.chat-header { background: linear-gradient(135deg, var(--terracotta) 0%, #b5603e 100%); padding: 20px 26px; display: flex; align-items: center; gap: 14px; flex-shrink: 0; }
.chat-avatar { width: 38px; height: 38px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 18px; }
.chat-header-text h3 { font-family: 'Playfair Display', serif; font-size: 1rem; color: #fff; font-weight: 600; }
.chat-header-text p { font-size: 0.73rem; color: rgba(255,255,255,0.75); font-weight: 300; }
.chat-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #a8e6a3; margin-left: auto; box-shadow: 0 0 6px rgba(168,230,163,0.8); animation: pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
.chat-messages { flex: 1; overflow-y: auto; padding: 24px 22px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
.chat-messages::-webkit-scrollbar { width: 4px; }
.chat-messages::-webkit-scrollbar-thumb { background: var(--sand-dark); border-radius: 4px; }
.message { display: flex; gap: 10px; align-items: flex-end; animation: fadeUp 0.3s ease; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.message.user { flex-direction: row-reverse; }
.msg-avatar { width: 30px; height: 30px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 13px; }
.message.ai .msg-avatar { background: linear-gradient(135deg, var(--terracotta) 0%, var(--bark) 100%); }
.message.user .msg-avatar { background: var(--sand); color: var(--text-mid); font-size: 10px; font-weight: 600; }
.msg-bubble { max-width: 78%; padding: 13px 17px; border-radius: 18px; font-size: 0.875rem; line-height: 1.55; font-weight: 300; }
.message.ai .msg-bubble { background: #fff; color: var(--text-dark); border: 1px solid var(--sand); border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(92,64,51,0.06); }
.message.user .msg-bubble { background: linear-gradient(135deg, var(--terracotta) 0%, #b5603e 100%); color: #fff; border-bottom-right-radius: 4px; }
.typing-indicator { display: flex; gap: 5px; padding: 14px 17px; background: #fff; border: 1px solid var(--sand); border-radius: 18px; border-bottom-left-radius: 4px; width: fit-content; box-shadow: 0 2px 8px rgba(92,64,51,0.06); }
.typing-indicator span { width: 7px; height: 7px; border-radius: 50%; background: var(--sand-dark); animation: bounce 1.2s infinite; }
.typing-indicator span:nth-child(2){animation-delay:0.2s}
.typing-indicator span:nth-child(3){animation-delay:0.4s}
@keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px);background:var(--terracotta-light)} }
.chat-footer { padding: 16px 18px; border-top: 1px solid var(--sand); background: var(--warm-white); flex-shrink: 0; }
.quick-prompts { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
.quick-prompt { font-size: 0.72rem; padding: 5px 12px; border-radius: 20px; border: 1px solid var(--sand-dark); background: transparent; color: var(--text-mid); cursor: pointer; font-family: 'Lato', sans-serif; transition: all 0.15s; }
.quick-prompt:hover { background: var(--sand); border-color: var(--terracotta); color: var(--terracotta); }
.chat-input-row { display: flex; gap: 10px; align-items: center; }
.chat-input { flex: 1; border: 1.5px solid var(--sand-dark); border-radius: 12px; padding: 11px 16px; font-size: 0.875rem; font-family: 'Lato', sans-serif; font-weight: 300; color: var(--text-dark); background: #fff; outline: none; transition: border-color 0.2s; }
.chat-input:focus { border-color: var(--terracotta); }
.chat-input::placeholder { color: var(--text-light); }
.send-btn { width: 44px; height: 44px; border-radius: 12px; background: linear-gradient(135deg, var(--terracotta) 0%, #b5603e 100%); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #fff; transition: all 0.2s; flex-shrink: 0; }
.send-btn:hover { transform: scale(1.05); box-shadow: 0 4px 14px rgba(196,113,74,0.4); }
.send-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.page-footer { text-align: center; padding: 24px; font-size: 0.75rem; color: var(--text-light); border-top: 1px solid var(--sand); }
.page-footer a { color: var(--terracotta); text-decoration: none; }

@media (max-width: 800px) {
  .hero-inner { padding: 32px 24px; }
  .main { grid-template-columns: 1fr; padding: 24px 20px 40px; }
  .hero-text h1 { font-size: 1.9rem; }
}
</style>
</head>
<body>

<div id="loadingScreen"><div class="spinner"></div><p>Loading booking page‚Ä¶</p></div>

<div class="hero">
  <div class="hero-inner">
    <div class="stylist-avatar" id="heroInitial">‚úÇÔ∏è</div>
    <div class="hero-text">
      <h1>Book with <em id="heroName">‚Ä¶</em></h1>
      <p id="heroSalon">Independent Hair Stylist</p>
      <div class="hero-badges" id="heroBadges"></div>
    </div>
  </div>
</div>

<div class="main">
  <div class="availability-panel">
    <div class="panel-header">
      <h2>Upcoming Availability</h2>
      <p id="availDateRange">Next 7 days</p>
    </div>
    <div class="availability-body">
      <div class="week-label">Open Slots</div>
      <div id="availabilityList"><div style="text-align:center;padding:20px;color:#9c7a6a;font-size:0.82rem;">Loading availability‚Ä¶</div></div>
      <div class="legend">
        <div class="legend-item"><span class="legend-dot open"></span> Available</div>
        <div class="legend-item"><span class="legend-dot booked"></span> Booked</div>
      </div>
    </div>
  </div>

  <div class="chat-panel">
    <div class="chat-header">
      <div class="chat-avatar">‚úÇÔ∏è</div>
      <div class="chat-header-text">
        <h3 id="chatHeaderName">Booking Assistant</h3>
        <p>Powered by AI ¬∑ Replies instantly</p>
      </div>
      <div class="chat-status-dot"></div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-footer">
      <div class="quick-prompts">
        <button class="quick-prompt" onclick="sendQuick('I\'d like to book an appointment')">üìÖ Book</button>
        <button class="quick-prompt" onclick="sendQuick('I need to reschedule my appointment')">üîÑ Reschedule</button>
        <button class="quick-prompt" onclick="sendQuick('I need to cancel my appointment')">‚ùå Cancel</button>
        <button class="quick-prompt" onclick="sendQuick('What times are available this week?')">üïê Availability</button>
      </div>
      <div class="chat-input-row">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type a message‚Ä¶" onkeydown="if(event.key==='Enter')sendMessage()">
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="page-footer">Powered by <a href="index.html">Salon Assist CX</a> ¬∑ AI scheduling for independent stylists</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let stylist = null;
let availabilityData = [];
let conversationHistory = [];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  // Get stylist slug from URL: booking.html?stylist=jasmine-rivera
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('stylist');

  if (!slug) {
    document.getElementById('loadingScreen').style.display = 'none';
    appendMessage('ai', "Sorry, no stylist was specified in this link. Please check the URL and try again.");
    return;
  }

  await loadStylistData(slug);
  await loadAvailability();

  renderHero();
  renderAvailabilityPanel();
  renderWelcomeMessage();

  document.getElementById('loadingScreen').style.display = 'none';
});

// ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStylistData(slug) {
  const { data, error } = await supabaseClient
    .from('stylists')
    .select('*')
    .eq('slug', slug)
    .single();

  if (error || !data) {
    stylist = { name: 'Your Stylist', slug, services: [], bio: '', salon_name: '' };
    return;
  }
  stylist = data;
  document.title = `Book with ${stylist.name} ‚Äî Salon Assist CX`;
}

async function loadAvailability() {
  if (!stylist?.id) return;
  const today = new Date().toISOString().split('T')[0];
  const futureDate = new Date(); futureDate.setDate(futureDate.getDate() + 14);
  const futureDateStr = futureDate.toISOString().split('T')[0];

  const { data, error } = await supabaseClient
    .from('availability')
    .select('*')
    .eq('stylist_id', stylist.id)
    .gte('date', today)
    .lte('date', futureDateStr)
    .order('date').order('time');

  if (!error) availabilityData = data || [];
}

// ‚îÄ‚îÄ RENDER HERO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHero() {
  if (!stylist) return;
  document.getElementById('heroInitial').textContent = stylist.name[0];
  document.getElementById('heroName').textContent = stylist.name;
  document.getElementById('heroSalon').textContent =
    [stylist.salon_name, 'Independent Hair Stylist'].filter(Boolean).join(' ¬∑ ');
  document.getElementById('chatHeaderName').textContent = `${stylist.name}'s Booking Assistant`;

  const badges = document.getElementById('heroBadges');
  badges.innerHTML = '';
  (stylist.services || []).slice(0, 4).forEach(s => {
    const b = document.createElement('span');
    b.className = 'badge';
    b.textContent = s;
    badges.appendChild(b);
  });
}

// ‚îÄ‚îÄ RENDER AVAILABILITY PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAvailabilityPanel() {
  const container = document.getElementById('availabilityList');
  container.innerHTML = '';

  // Group by date
  const byDate = {};
  availabilityData.forEach(slot => {
    if (!byDate[slot.date]) byDate[slot.date] = [];
    byDate[slot.date].push(slot);
  });

  const dates = Object.keys(byDate).sort().slice(0, 7);

  if (!dates.length) {
    container.innerHTML = '<div style="text-align:center;padding:20px;color:#9c7a6a;font-size:0.82rem;font-style:italic;">No availability set yet</div>';
    return;
  }

  dates.forEach(dateStr => {
    const slots = byDate[dateStr];
    const label = new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
    const row = document.createElement('div');
    row.className = 'day-row';

    const name = document.createElement('div');
    name.className = 'day-name';
    name.textContent = label;

    const slotsEl = document.createElement('div');
    slotsEl.className = 'slots';

    slots.forEach(s => {
      const chip = document.createElement('span');
      chip.className = `slot ${s.is_booked ? 'booked' : 'open'}`;
      chip.textContent = s.time;
      slotsEl.appendChild(chip);
    });

    row.appendChild(name);
    row.appendChild(slotsEl);
    container.appendChild(row);
  });
}

// ‚îÄ‚îÄ WELCOME MESSAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderWelcomeMessage() {
  const msg = stylist?.welcome_message ||
    `Hi there! üëã I'm ${stylist?.name || 'your stylist'}'s booking assistant. I can help you **book**, **reschedule**, or **cancel** an appointment. What would you like to do today?`;
  appendMessage('ai', msg);
}

// ‚îÄ‚îÄ BUILD SYSTEM PROMPT (uses LIVE data) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildSystemPrompt() {
  const today = new Date().toISOString().split('T')[0];

  // Group availability into readable format
  const byDate = {};
  availabilityData.forEach(s => {
    const label = new Date(s.date + 'T12:00:00').toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });
    if (!byDate[label]) byDate[label] = { open: [], booked: [] };
    (s.is_booked ? byDate[label].booked : byDate[label].open).push(s.time);
  });

  const availStr = Object.entries(byDate).map(([day, slots]) => {
    const open = slots.open.length ? `Available: ${slots.open.join(', ')}` : 'No open slots';
    return `${day}: ${open}`;
  }).join('\n') || 'No availability currently set.';

  return `You are a warm, professional booking assistant for ${stylist.name}, an independent hairstylist${stylist.salon_name ? ` at ${stylist.salon_name}` : ''}.

TODAY'S DATE: ${new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' })}.

${stylist.bio ? `ABOUT ${stylist.name.toUpperCase()}: ${stylist.bio}` : ''}

SERVICES OFFERED: ${(stylist.services || []).join(', ') || 'Various hair services'}

LIVE AVAILABILITY (next 14 days):
${availStr}

YOUR ROLE:
- Help customers BOOK new appointments (collect: name, service, preferred date/time from available slots)
- Help customers RESCHEDULE (ask for name/current appointment, offer alternatives)
- Help customers CANCEL (confirm their name and appointment details)
- Answer questions about services or the stylist

BOOKING RULES:
- Only offer slots listed as "Available" above ‚Äî never suggest a booked slot
- When a customer confirms a booking, tell them it's confirmed and summarize: name, service, date, time
- Be warm and conversational ‚Äî like a friendly salon receptionist
- Keep responses concise; avoid long paragraphs
- Use light emojis occasionally

IMPORTANT: When a customer successfully books, end your message with exactly this on a new line so the system can process it:
BOOKING_CONFIRMED:name=[customer name]|service=[service]|date=[YYYY-MM-DD]|time=[time]`;
}

// ‚îÄ‚îÄ CLAUDE API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function callClaude(userMessage) {
  conversationHistory.push({ role: 'user', content: userMessage });

  const response = await fetch('/api/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1000,
      system: buildSystemPrompt(),
      messages: conversationHistory
    })
  });

  const data = await response.json();
  const reply = data.content?.map(b => b.text || '').join('') || "I'm having trouble connecting. Please try again.";
  conversationHistory.push({ role: 'assistant', content: reply });
  return reply;
}

// ‚îÄ‚îÄ PROCESS BOOKING CONFIRMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function processBookingIfConfirmed(reply) {
  if (!reply.includes('BOOKING_CONFIRMED:')) return;
  try {
    const match = reply.match(/BOOKING_CONFIRMED:name=([^|]+)\|service=([^|]+)\|date=([^|]+)\|time=(.+)/);
    if (!match) return;
    const [, customerName, service, date, time] = match.map(s => s.trim());

    // Find the availability slot
    const slot = availabilityData.find(s => s.date === date && s.time === time && !s.is_booked);
    if (!slot) return;

    // Create appointment in database
    await supabaseClient.from('appointments').insert({
      stylist_id: stylist.id,
      availability_id: slot.id,
      customer_name: customerName,
      service,
      date,
      time,
      status: 'confirmed'
    });

    // Mark slot as booked
    await supabaseClient.from('availability').update({ is_booked: true }).eq('id', slot.id);

    // Refresh local availability
    await loadAvailability();
    renderAvailabilityPanel();
  } catch (e) {
    console.error('Booking processing error:', e);
  }
}

// ‚îÄ‚îÄ SEND MESSAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('sendBtn');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  btn.disabled = true;
  appendMessage('user', text);
  showTyping();

  try {
    const reply = await callClaude(text);
    hideTyping();
    // Hide the BOOKING_CONFIRMED marker from the displayed message
    const displayReply = reply.replace(/\nBOOKING_CONFIRMED:.+/s, '').trim();
    appendMessage('ai', displayReply);
    await processBookingIfConfirmed(reply);
  } catch (e) {
    hideTyping();
    appendMessage('ai', "Oops! Something went wrong. Please try again in a moment.");
  }

  btn.disabled = false;
  input.focus();
}

function sendQuick(msg) { document.getElementById('chatInput').value = msg; sendMessage(); }

// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function appendMessage(role, text) {
  const container = document.getElementById('chatMessages');
  const wrap = document.createElement('div');
  wrap.className = `message ${role}`;

  const avatar = document.createElement('div');
  avatar.className = 'msg-avatar';
  avatar.textContent = role === 'ai' ? '‚úÇÔ∏è' : (stylist?.name?.[0] || 'Y');
  if (role === 'user') { avatar.style.fontSize = '10px'; avatar.style.fontWeight = '600'; }

  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

  wrap.appendChild(avatar);
  wrap.appendChild(bubble);
  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}

function showTyping() {
  const container = document.getElementById('chatMessages');
  const wrap = document.createElement('div');
  wrap.className = 'message ai'; wrap.id = 'typingWrap';
  const avatar = document.createElement('div'); avatar.className = 'msg-avatar'; avatar.textContent = '‚úÇÔ∏è';
  const ind = document.createElement('div'); ind.className = 'typing-indicator';
  ind.innerHTML = '<span></span><span></span><span></span>';
  wrap.appendChild(avatar); wrap.appendChild(ind);
  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}

function hideTyping() { document.getElementById('typingWrap')?.remove(); }
</script>
</body>
</html>
