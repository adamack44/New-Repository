<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Salon Assist CX ‚Äî Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://pwytzdclfiuepbcceoqd.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3eXR6ZGNsZml1ZXBiY2Nlb3FkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTUzMzAsImV4cCI6MjA4NzI5MTMzMH0.lemmT3-2ooVyQN9X-wVnssqJ1epZ4DCoLEMy23gfYSE';
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --ink: #16100c; --ink-mid: #3d2b1f; --ink-light: #7a5c4a;
  --rust: #b85c38; --rust-light: #d4744f; --rust-pale: #f5e8e1;
  --sage: #5e7a64; --sage-pale: #e8f0e9;
  --sand: #e8d9c8; --sand-light: #f5ede3; --cream: #faf6f1;
  --white: #ffffff; --border: #e0ccb8; --sidebar-w: 240px;
}
body { font-family: 'DM Sans', sans-serif; background: var(--cream); color: var(--ink); display: flex; min-height: 100vh; font-size: 14px; }

/* LOADING SCREEN */
#loadingScreen {
  position: fixed; inset: 0; background: var(--cream);
  display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 999; gap: 16px;
}
#loadingScreen .spinner {
  width: 36px; height: 36px; border-radius: 50%;
  border: 3px solid var(--sand); border-top-color: var(--rust);
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
#loadingScreen p { font-size: 0.85rem; color: var(--ink-light); font-weight: 300; }

/* SIDEBAR */
.sidebar {
  width: var(--sidebar-w); background: var(--ink);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; bottom: 0; z-index: 100; padding: 0 0 24px;
}
.sidebar-brand { padding: 26px 24px 22px; border-bottom: 1px solid rgba(255,255,255,0.07); }
.brand-mark { display: flex; align-items: center; gap: 10px; }
.brand-icon { width: 34px; height: 34px; border-radius: 10px; background: linear-gradient(135deg, var(--rust) 0%, #8b3a1e 100%); display: flex; align-items: center; justify-content: center; font-size: 16px; }
.brand-name { font-family: 'DM Serif Display', serif; font-size: 1.2rem; color: var(--cream); }
.brand-name span { color: var(--rust-light); font-style: italic; }
.stylist-pill { margin: 16px 16px 0; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.09); border-radius: 12px; padding: 12px 14px; display: flex; align-items: center; gap: 12px; }
.stylist-pill-avatar { width: 36px; height: 36px; border-radius: 50%; background: linear-gradient(135deg, var(--rust) 0%, #6b2e10 100%); font-family: 'DM Serif Display', serif; font-size: 16px; color: var(--cream); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.stylist-pill-info p:first-child { font-size: 0.82rem; font-weight: 600; color: var(--cream); line-height: 1.2; }
.stylist-pill-info p:last-child { font-size: 0.7rem; color: rgba(255,255,255,0.4); margin-top: 1px; }
.nav { padding: 24px 12px 0; flex: 1; }
.nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; cursor: pointer; color: rgba(255,255,255,0.5); font-size: 0.85rem; font-weight: 400; transition: all 0.15s; margin-bottom: 2px; user-select: none; }
.nav-item:hover { background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.8); }
.nav-item.active { background: rgba(184,92,56,0.2); color: var(--rust-light); font-weight: 500; }
.nav-icon { font-size: 16px; width: 20px; text-align: center; flex-shrink: 0; }
.nav-badge { margin-left: auto; background: var(--rust); color: #fff; font-size: 0.62rem; font-weight: 600; padding: 2px 7px; border-radius: 10px; }
.sidebar-footer { padding: 0 12px; border-top: 1px solid rgba(255,255,255,0.07); padding-top: 16px; display: flex; flex-direction: column; gap: 8px; }
.copy-link-btn { width: 100%; padding: 11px 14px; border-radius: 10px; background: linear-gradient(135deg, var(--rust) 0%, #8b3a1e 100%); border: none; color: #fff; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
.copy-link-btn:hover { filter: brightness(1.1); }
.signout-btn { width: 100%; padding: 9px 14px; border-radius: 10px; background: transparent; border: 1px solid rgba(255,255,255,0.12); color: rgba(255,255,255,0.4); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; cursor: pointer; transition: all 0.2s; }
.signout-btn:hover { border-color: rgba(255,255,255,0.25); color: rgba(255,255,255,0.7); }

/* MAIN */
.main-area { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
.topbar { height: 64px; background: var(--white); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 36px; gap: 16px; position: sticky; top: 0; z-index: 50; }
.topbar-title { font-family: 'DM Serif Display', serif; font-size: 1.35rem; color: var(--ink); flex: 1; }
.topbar-date { font-size: 0.8rem; color: var(--ink-light); font-weight: 300; }
.btn { padding: 8px 18px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.15s; border: none; }
.btn-ghost { background: transparent; color: var(--ink-light); border: 1px solid var(--border); }
.btn-ghost:hover { background: var(--sand-light); }
.btn-primary { background: linear-gradient(135deg, var(--rust) 0%, #983016 100%); color: #fff; box-shadow: 0 2px 8px rgba(184,92,56,0.3); }
.btn-primary:hover { filter: brightness(1.08); }
.content { padding: 32px 36px; flex: 1; }

/* STATS */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
.stat-card { background: var(--white); border: 1px solid var(--border); border-radius: 16px; padding: 20px 22px; animation: fadeUp 0.4s ease both; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
.stat-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.8px; color: var(--ink-light); font-weight: 500; margin-bottom: 8px; }
.stat-value { font-family: 'DM Serif Display', serif; font-size: 2rem; color: var(--ink); line-height: 1; margin-bottom: 6px; }
.stat-sub { font-size: 0.72rem; color: var(--ink-light); }

/* TWO COL */
.two-col { display: grid; grid-template-columns: 1.4fr 1fr; gap: 20px; margin-bottom: 20px; }
.card { background: var(--white); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; animation: fadeUp 0.45s ease both; }
.card-head { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
.card-head h2 { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--ink); font-weight: 400; }
.card-body { padding: 20px 22px; }

/* APPOINTMENTS */
.appt-list { display: flex; flex-direction: column; gap: 10px; }
.appt-item { display: flex; align-items: center; gap: 14px; padding: 13px 16px; border-radius: 12px; background: var(--cream); border: 1px solid var(--border); transition: all 0.15s; }
.appt-item:hover { border-color: var(--rust-light); background: var(--rust-pale); }
.appt-time { font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--rust); min-width: 52px; flex-shrink: 0; }
.appt-divider { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }
.appt-info { flex: 1; }
.appt-name { font-weight: 600; font-size: 0.875rem; color: var(--ink); line-height: 1.2; }
.appt-service { font-size: 0.75rem; color: var(--ink-light); margin-top: 2px; }
.appt-status { font-size: 0.68rem; font-weight: 600; padding: 3px 9px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; flex-shrink: 0; }
.appt-status.confirmed { background: var(--sage-pale); color: var(--sage); }
.appt-status.pending { background: #fef3e2; color: #c47d0a; }
.appt-status.cancelled { background: #fdecea; color: #c0392b; }
.appt-btn { width: 28px; height: 28px; border-radius: 7px; border: 1px solid var(--border); background: var(--white); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 13px; transition: all 0.1s; color: var(--ink-light); margin-left: 4px; }
.appt-btn:hover { border-color: var(--rust); color: var(--rust); background: var(--rust-pale); }
.empty-state { text-align: center; padding: 32px 16px; color: var(--ink-light); font-size: 0.85rem; font-weight: 300; }

/* AVAILABILITY */
.avail-day-row { display: flex; align-items: center; gap: 14px; padding: 13px 0; border-bottom: 1px solid var(--border); }
.avail-day-row:last-child { border-bottom: none; }
.avail-toggle-wrap { display: flex; align-items: center; gap: 10px; width: 100px; flex-shrink: 0; }
.toggle { position: relative; width: 38px; height: 22px; cursor: pointer; flex-shrink: 0; }
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-track { position: absolute; inset: 0; border-radius: 11px; background: var(--border); transition: background 0.2s; }
.toggle input:checked + .toggle-track { background: var(--sage); }
.toggle-thumb { position: absolute; top: 3px; left: 3px; width: 16px; height: 16px; border-radius: 50%; background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.2); transition: transform 0.2s; }
.toggle input:checked ~ .toggle-thumb { transform: translateX(16px); }
.avail-day-name { font-size: 0.82rem; font-weight: 500; color: var(--ink); }
.avail-slots-wrap { flex: 1; display: flex; gap: 7px; flex-wrap: wrap; align-items: center; }
.slot-chip { display: flex; align-items: center; gap: 5px; background: var(--sage-pale); border: 1px solid rgba(94,122,100,0.25); border-radius: 7px; padding: 4px 8px; font-size: 0.72rem; color: var(--sage); font-weight: 500; cursor: pointer; transition: all 0.1s; }
.slot-chip:hover { background: #d4e8d4; }
.add-slot-btn { width: 26px; height: 26px; border-radius: 7px; border: 1.5px dashed var(--border); background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: var(--ink-light); transition: all 0.15s; }
.add-slot-btn:hover { border-color: var(--rust); color: var(--rust); background: var(--rust-pale); }
.day-off-label { font-size: 0.75rem; color: var(--ink-light); font-style: italic; }
.saving-indicator { font-size: 0.72rem; color: var(--sage); margin-left: 8px; display: none; }

/* PROFILE */
.profile-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.form-group { display: flex; flex-direction: column; gap: 5px; }
.form-group.full { grid-column: 1/-1; }
.form-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.6px; color: var(--ink-light); font-weight: 500; }
.form-input { padding: 10px 13px; border: 1.5px solid var(--border); border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; color: var(--ink); background: var(--cream); outline: none; transition: border-color 0.15s; }
.form-input:focus { border-color: var(--rust-light); background: #fff; }
.service-tags { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 6px; }
.service-tag { padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: all 0.12s; border: 1.5px solid var(--border); background: var(--cream); color: var(--ink-light); }
.service-tag.on { background: var(--rust-pale); border-color: var(--rust-light); color: var(--rust); }

/* PAGE SECTIONS */
.page-section { display: none; }
.page-section.active { display: block; }

/* MODAL */
.modal-overlay { position: fixed; inset: 0; background: rgba(26,18,13,0.55); backdrop-filter: blur(4px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal { background: var(--white); border-radius: 20px; width: 380px; padding: 28px; box-shadow: 0 24px 64px rgba(26,18,13,0.25); transform: translateY(16px); transition: transform 0.2s; }
.modal-overlay.open .modal { transform: translateY(0); }
.modal h3 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 6px; }
.modal p { font-size: 0.83rem; color: var(--ink-light); margin-bottom: 20px; }
.date-input { width: 100%; margin-bottom: 14px; padding: 10px 13px; border: 1.5px solid var(--border); border-radius: 9px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; color: var(--ink); background: var(--cream); outline: none; }
.date-input:focus { border-color: var(--rust-light); }
.time-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
.time-option { padding: 8px; border-radius: 9px; border: 1.5px solid var(--border); background: var(--cream); font-family: 'DM Sans', sans-serif; font-size: 0.78rem; font-weight: 500; cursor: pointer; text-align: center; color: var(--ink); transition: all 0.12s; }
.time-option:hover { border-color: var(--sage); color: var(--sage); background: var(--sage-pale); }
.time-option.selected { border-color: var(--sage); background: var(--sage-pale); color: var(--sage); }
.modal-actions { display: flex; gap: 10px; justify-content: flex-end; }

/* TOAST */
.toast { position: fixed; bottom: 28px; right: 28px; background: var(--ink); color: var(--cream); padding: 12px 20px; border-radius: 12px; font-size: 0.83rem; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 28px rgba(0,0,0,0.25); transform: translateY(80px); opacity: 0; transition: all 0.3s cubic-bezier(0.34,1.4,0.64,1); z-index: 300; }
.toast.show { transform: translateY(0); opacity: 1; }

/* MINI CALENDAR */
.mini-cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
.cal-day-name { text-align: center; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--ink-light); padding-bottom: 6px; }
.cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.78rem; cursor: pointer; transition: all 0.1s; color: var(--ink); }
.cal-day:hover { background: var(--sand-light); }
.cal-day.other-month { color: rgba(90,60,40,0.2); cursor: default; }
.cal-day.other-month:hover { background: none; }
.cal-day.today { background: var(--rust); color: #fff; font-weight: 600; }
.cal-day.has-appt::after { content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; border-radius: 50%; background: var(--sage); }
.cal-day { position: relative; }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen">
  <div class="spinner"></div>
  <p>Loading your dashboard‚Ä¶</p>
</div>

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sidebar-brand">
    <div class="brand-mark">
      <div class="brand-icon">‚úÇÔ∏è</div>
      <div class="brand-name">Salon Assist <span>CX</span></div>
    </div>
  </div>
  <div class="stylist-pill">
    <div class="stylist-pill-avatar" id="sidebarInitial">J</div>
    <div class="stylist-pill-info">
      <p id="sidebarName">Loading‚Ä¶</p>
      <p>Pro Plan ¬∑ Active</p>
    </div>
  </div>
  <div class="nav">
    <div class="nav-item active" onclick="showPage('overview', this)"><span class="nav-icon">üè†</span> Overview</div>
    <div class="nav-item" onclick="showPage('appointments', this)"><span class="nav-icon">üìÖ</span> Appointments <span class="nav-badge" id="apptBadge">0</span></div>
    <div class="nav-item" onclick="showPage('availability', this)"><span class="nav-icon">üïê</span> Availability</div>
    <div class="nav-item" onclick="showPage('profile', this)"><span class="nav-icon">üë§</span> My Profile</div>
  </div>
  <div class="sidebar-footer">
    <button class="copy-link-btn" onclick="copyBookingLink()">üîó Copy Booking Link</button>
    <button class="signout-btn" onclick="signOut()">Sign Out</button>
  </div>
</nav>

<!-- MAIN -->
<div class="main-area">
  <header class="topbar">
    <div class="topbar-title" id="pageTitle">Overview</div>
    <div class="topbar-date" id="topbarDate"></div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-ghost" onclick="openAddSlotModal()">+ Add Slot</button>
      <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
    </div>
  </header>

  <div class="content">

    <!-- OVERVIEW -->
    <div class="page-section active" id="page-overview">
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">Today's Appointments</div>
          <div class="stat-value" id="statToday">‚Äî</div>
          <div class="stat-sub">Scheduled for today</div>
        </div>
        <div class="stat-card" style="animation-delay:0.05s">
          <div class="stat-label">This Week</div>
          <div class="stat-value" id="statWeek">‚Äî</div>
          <div class="stat-sub">Total this week</div>
        </div>
        <div class="stat-card" style="animation-delay:0.1s">
          <div class="stat-label">Open Slots Today</div>
          <div class="stat-value" id="statOpen">‚Äî</div>
          <div class="stat-sub">Available to book</div>
        </div>
        <div class="stat-card" style="animation-delay:0.15s">
          <div class="stat-label">Total Appointments</div>
          <div class="stat-value" id="statTotal">‚Äî</div>
          <div class="stat-sub">All time</div>
        </div>
      </div>
      <div class="two-col">
        <div class="card">
          <div class="card-head"><h2>Today's Schedule</h2></div>
          <div class="card-body">
            <div class="appt-list" id="todayApptList"><div class="empty-state">Loading appointments‚Ä¶</div></div>
          </div>
        </div>
        <div class="card">
          <div class="card-head"><h2 id="calTitle"></h2></div>
          <div class="card-body">
            <div class="mini-cal-grid" id="calGrid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ALL APPOINTMENTS -->
    <div class="page-section" id="page-appointments">
      <div class="card">
        <div class="card-head"><h2>All Appointments</h2></div>
        <div class="card-body">
          <div class="appt-list" id="allApptList"><div class="empty-state">Loading‚Ä¶</div></div>
        </div>
      </div>
    </div>

    <!-- AVAILABILITY -->
    <div class="page-section" id="page-availability">
      <div class="card">
        <div class="card-head">
          <h2>Availability Manager</h2>
          <span class="saving-indicator" id="savingIndicator">Saving‚Ä¶</span>
        </div>
        <div class="card-body">
          <div id="availManager"><div class="empty-state">Loading availability‚Ä¶</div></div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="page-section" id="page-profile">
      <div class="card">
        <div class="card-head"><h2>My Profile</h2></div>
        <div class="card-body">
          <div class="profile-grid">
            <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="profileName"></div>
            <div class="form-group"><label class="form-label">Salon / Studio</label><input class="form-input" id="profileSalon"></div>
            <div class="form-group"><label class="form-label">Phone</label><input class="form-input" id="profilePhone"></div>
            <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="profileEmail" disabled></div>
            <div class="form-group full"><label class="form-label">Bio</label><textarea class="form-input" id="profileBio" rows="3" style="resize:vertical"></textarea></div>
            <div class="form-group full">
              <label class="form-label">Services Offered (click to toggle)</label>
              <div class="service-tags" id="serviceTags"></div>
            </div>
          </div>
          <div style="margin-top:20px;display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn btn-ghost" onclick="loadProfile()">Discard</button>
            <button class="btn btn-primary" onclick="saveProfile()">Save Profile</button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ADD SLOT MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <h3>Add Available Slot</h3>
    <p>Choose a date and time to open for bookings.</p>
    <label class="form-label" style="margin-bottom:6px;display:block;">Date</label>
    <input type="date" class="date-input" id="slotDate">
    <label class="form-label" style="margin-bottom:8px;display:block;">Time</label>
    <div class="time-options" id="timeOptions"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddSlot()">Add Slot</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let stylist = null;
let appointments = [];
let availability = [];
let selectedModalTime = null;

const ALL_TIMES = ["8:00am","8:30am","9:00am","9:30am","10:00am","10:30am","11:00am","11:30am",
  "12:00pm","12:30pm","1:00pm","1:30pm","2:00pm","2:30pm","3:00pm","3:30pm","4:00pm","4:30pm","5:00pm","5:30pm"];

const ALL_SERVICES = ["Color","Natural Hair","Braids","Locs","Silk Press","Cuts","Highlights","Extensions","Wigs","Blowout"];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', async () => {
  // Check if logged in
  const { data: { user } } = await supabaseClient.auth.getUser();
  if (!user) { window.location.href = 'login.html'; return; }

  await loadStylistProfile(user);
  await Promise.all([loadAppointments(), loadAvailability()]);

  document.getElementById('topbarDate').textContent =
    new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });

  renderCalendar();
  renderStats();
  renderTodayAppointments();
  renderAllAppointments();

  document.getElementById('loadingScreen').style.display = 'none';
});

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function signOut() {
  await supabaseClient.auth.signOut();
  window.location.href = 'login.html';
}

// ‚îÄ‚îÄ LOAD DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStylistProfile(user) {
  const { data, error } = await supabaseClient
    .from('stylists')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (error || !data) { showToast('‚ö†Ô∏è Could not load profile'); return; }
  stylist = data;

  // Update sidebar
  document.getElementById('sidebarName').textContent = stylist.name;
  document.getElementById('sidebarInitial').textContent = stylist.name[0];

  // Populate profile form
  document.getElementById('profileName').value = stylist.name || '';
  document.getElementById('profileSalon').value = stylist.salon_name || '';
  document.getElementById('profilePhone').value = stylist.phone || '';
  document.getElementById('profileEmail').value = stylist.email || '';
  document.getElementById('profileBio').value = stylist.bio || '';

  // Render service tags
  const tagContainer = document.getElementById('serviceTags');
  tagContainer.innerHTML = '';
  ALL_SERVICES.forEach(s => {
    const tag = document.createElement('span');
    tag.className = 'service-tag' + ((stylist.services || []).includes(s) ? ' on' : '');
    tag.textContent = s;
    tag.onclick = () => tag.classList.toggle('on');
    tagContainer.appendChild(tag);
  });
}

async function loadAppointments() {
  if (!stylist) return;
  const { data, error } = await supabaseClient
    .from('appointments')
    .select('*')
    .eq('stylist_id', stylist.id)
    .order('date', { ascending: true })
    .order('time', { ascending: true });

  if (!error) appointments = data || [];
  document.getElementById('apptBadge').textContent = appointments.filter(a => a.status !== 'cancelled').length;
}

async function loadAvailability() {
  if (!stylist) return;
  const today = new Date().toISOString().split('T')[0];
  const { data, error } = await supabaseClient
    .from('availability')
    .select('*')
    .eq('stylist_id', stylist.id)
    .gte('date', today)
    .order('date', { ascending: true })
    .order('time', { ascending: true });

  if (!error) availability = data || [];
  if (document.getElementById('page-availability').classList.contains('active')) {
    renderAvailability();
  }
}

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStats() {
  const today = new Date().toISOString().split('T')[0];
  const weekEnd = new Date(); weekEnd.setDate(weekEnd.getDate() + 7);
  const weekEndStr = weekEnd.toISOString().split('T')[0];

  const todayAppts = appointments.filter(a => a.date === today && a.status !== 'cancelled');
  const weekAppts = appointments.filter(a => a.date >= today && a.date <= weekEndStr && a.status !== 'cancelled');
  const openToday = availability.filter(a => a.date === today && !a.is_booked);

  document.getElementById('statToday').textContent = todayAppts.length;
  document.getElementById('statWeek').textContent = weekAppts.length;
  document.getElementById('statOpen').textContent = openToday.length;
  document.getElementById('statTotal').textContent = appointments.filter(a => a.status !== 'cancelled').length;
}

// ‚îÄ‚îÄ APPOINTMENTS UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTodayAppointments() {
  const today = new Date().toISOString().split('T')[0];
  const todayAppts = appointments.filter(a => a.date === today);
  const el = document.getElementById('todayApptList');
  if (!todayAppts.length) { el.innerHTML = '<div class="empty-state">No appointments today ‚ú®</div>'; return; }
  el.innerHTML = '';
  todayAppts.forEach(a => el.appendChild(buildApptItem(a)));
}

function renderAllAppointments() {
  const el = document.getElementById('allApptList');
  if (!appointments.length) { el.innerHTML = '<div class="empty-state">No appointments yet</div>'; return; }
  el.innerHTML = '';
  appointments.forEach(a => el.appendChild(buildApptItem(a)));
}

function buildApptItem(a) {
  const div = document.createElement('div');
  div.className = 'appt-item';
  div.innerHTML = `
    <div class="appt-time">${a.time}</div>
    <div class="appt-divider"></div>
    <div class="appt-info">
      <div class="appt-name">${a.customer_name}</div>
      <div class="appt-service">${a.service || 'Service not specified'} ¬∑ ${formatDate(a.date)}</div>
    </div>
    <span class="appt-status ${a.status}">${a.status}</span>
    ${a.status !== 'cancelled' ? `<button class="appt-btn" title="Cancel" onclick="cancelAppointment('${a.id}')">‚úï</button>` : ''}
  `;
  return div;
}

function formatDate(dateStr) {
  return new Date(dateStr + 'T12:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' });
}

async function cancelAppointment(id) {
  const { error } = await supabaseClient.from('appointments').update({ status: 'cancelled' }).eq('id', id);
  if (error) { showToast('‚ö†Ô∏è Could not cancel appointment'); return; }
  await loadAppointments();
  renderTodayAppointments();
  renderAllAppointments();
  renderStats();
  showToast('‚ùå Appointment cancelled');
}

// ‚îÄ‚îÄ AVAILABILITY UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAvailability() {
  const container = document.getElementById('availManager');
  container.innerHTML = '';

  // Group by date
  const byDate = {};
  availability.forEach(slot => {
    if (!byDate[slot.date]) byDate[slot.date] = [];
    byDate[slot.date].push(slot);
  });

  // Show next 14 days
  for (let i = 0; i < 14; i++) {
    const d = new Date(); d.setDate(d.getDate() + i);
    const dateStr = d.toISOString().split('T')[0];
    const label = d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
    const slots = byDate[dateStr] || [];

    const row = document.createElement('div');
    row.className = 'avail-day-row';

    const nameEl = document.createElement('div');
    nameEl.style.cssText = 'min-width:120px;flex-shrink:0;font-size:0.82rem;font-weight:500;color:var(--ink)';
    nameEl.textContent = label;

    const slotsWrap = document.createElement('div');
    slotsWrap.className = 'avail-slots-wrap';

    slots.forEach(slot => {
      const chip = document.createElement('div');
      chip.className = 'slot-chip';
      chip.style.cssText = slot.is_booked ? 'opacity:0.5;text-decoration:line-through;cursor:default' : '';
      chip.innerHTML = `${slot.time}${!slot.is_booked ? ' <span onclick="removeSlot(\'' + slot.id + '\')" style="opacity:0.6;font-size:10px;">‚úï</span>' : ' üîí'}`;
      slotsWrap.appendChild(chip);
    });

    const addBtn = document.createElement('button');
    addBtn.className = 'add-slot-btn';
    addBtn.textContent = '+';
    addBtn.title = 'Add a slot for this day';
    addBtn.onclick = () => openAddSlotModalForDate(dateStr);
    slotsWrap.appendChild(addBtn);

    row.appendChild(nameEl);
    row.appendChild(slotsWrap);
    container.appendChild(row);
  }
}

async function removeSlot(id) {
  document.getElementById('savingIndicator').style.display = 'inline';
  const { error } = await supabaseClient.from('availability').delete().eq('id', id);
  document.getElementById('savingIndicator').style.display = 'none';
  if (error) { showToast('‚ö†Ô∏è Could not remove slot'); return; }
  await loadAvailability();
  showToast('üóëÔ∏è Slot removed');
}

// ‚îÄ‚îÄ ADD SLOT MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openAddSlotModal() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('slotDate').value = today;
  document.getElementById('slotDate').min = today;
  selectedModalTime = null;
  renderTimeOptions(today);
  document.getElementById('modalOverlay').classList.add('open');
}

function openAddSlotModalForDate(dateStr) {
  document.getElementById('slotDate').value = dateStr;
  document.getElementById('slotDate').min = new Date().toISOString().split('T')[0];
  selectedModalTime = null;
  renderTimeOptions(dateStr);
  document.getElementById('modalOverlay').classList.add('open');
}

function renderTimeOptions(dateStr) {
  const taken = availability.filter(a => a.date === dateStr).map(a => a.time);
  const opts = document.getElementById('timeOptions');
  opts.innerHTML = '';
  ALL_TIMES.forEach(t => {
    if (taken.includes(t)) return;
    const btn = document.createElement('button');
    btn.className = 'time-option';
    btn.textContent = t;
    btn.onclick = () => {
      document.querySelectorAll('.time-option').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedModalTime = t;
    };
    opts.appendChild(btn);
  });
  if (!opts.children.length) opts.innerHTML = '<div style="grid-column:1/-1;text-align:center;font-size:0.8rem;color:var(--ink-light);padding:12px;">All times already added for this day</div>';
}

document.getElementById('slotDate').addEventListener('change', e => renderTimeOptions(e.target.value));

function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }

async function confirmAddSlot() {
  if (!selectedModalTime) { showToast('‚ö†Ô∏è Please select a time'); return; }
  const dateStr = document.getElementById('slotDate').value;
  if (!dateStr) { showToast('‚ö†Ô∏è Please select a date'); return; }

  const { error } = await supabaseClient.from('availability').insert({
    stylist_id: stylist.id,
    date: dateStr,
    time: selectedModalTime,
    is_booked: false
  });

  if (error) { showToast(error.code === '23505' ? '‚ö†Ô∏è Slot already exists' : '‚ö†Ô∏è Could not add slot'); return; }
  closeModal();
  await loadAvailability();
  renderStats();
  showToast(`‚úÖ ${selectedModalTime} added for ${formatDate(dateStr)}`);
}

// ‚îÄ‚îÄ PROFILE SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveProfile() {
  if (!stylist) return;
  const services = [...document.querySelectorAll('.service-tag.on')].map(t => t.textContent);

  const { error } = await supabaseClient.from('stylists').update({
    name: document.getElementById('profileName').value,
    salon_name: document.getElementById('profileSalon').value,
    phone: document.getElementById('profilePhone').value,
    bio: document.getElementById('profileBio').value,
    services
  }).eq('id', stylist.id);

  if (error) { showToast('‚ö†Ô∏è Could not save profile'); return; }
  stylist.name = document.getElementById('profileName').value;
  document.getElementById('sidebarName').textContent = stylist.name;
  document.getElementById('sidebarInitial').textContent = stylist.name[0];
  showToast('‚úÖ Profile saved!');
}

async function loadProfile() {
  const { data: { user } } = await supabaseClient.auth.getUser();
  await loadStylistProfile(user);
  showToast('‚Ü©Ô∏è Changes discarded');
}

// ‚îÄ‚îÄ BOOKING LINK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function copyBookingLink() {
  if (!stylist) return;
  const link = `${window.location.origin}/booking.html?stylist=${stylist.slug}`;
  navigator.clipboard.writeText(link).catch(() => {});
  showToast('üîó Booking link copied!');
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showPage(id, el) {
  document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById('page-' + id).classList.add('active');
  if (el) el.classList.add('active');
  const titles = { overview:'Overview', appointments:'Appointments', availability:'Availability', profile:'My Profile' };
  document.getElementById('pageTitle').textContent = titles[id] || id;
  if (id === 'availability') renderAvailability();
  if (id === 'appointments') renderAllAppointments();
}

// ‚îÄ‚îÄ CALENDAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCalendar() {
  const now = new Date();
  const year = now.getFullYear(); const month = now.getMonth();
  document.getElementById('calTitle').textContent =
    now.toLocaleDateString('en-US', { month:'long', year:'numeric' });
  const grid = document.getElementById('calGrid');
  grid.innerHTML = '';
  ['Su','Mo','Tu','We','Th','Fr','Sa'].forEach(d => {
    const el = document.createElement('div'); el.className = 'cal-day-name'; el.textContent = d; grid.appendChild(el);
  });
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const apptDates = new Set(appointments.map(a => a.date));
  for (let i = 0; i < firstDay; i++) { const el = document.createElement('div'); el.className = 'cal-day other-month'; grid.appendChild(el); }
  for (let d = 1; d <= daysInMonth; d++) {
    const el = document.createElement('div'); el.className = 'cal-day';
    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if (d === now.getDate()) el.classList.add('today');
    if (apptDates.has(dateStr)) el.classList.add('has-appt');
    el.textContent = d;
    grid.appendChild(el);
  }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2600);
}
</script>
</body>
</html>
